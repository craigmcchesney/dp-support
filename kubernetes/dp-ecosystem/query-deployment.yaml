apiVersion: apps/v1
kind: Deployment
metadata:
  name: query-service
  namespace: dp-ecosystem
  labels:
    app: query-service
    component: backend
spec:
  replicas: 2  # Start with 2 replicas, HPA will manage scaling
  selector:
    matchLabels:
      app: query-service
  template:
    metadata:
      labels:
        app: query-service
    spec:
      containers:
      - name: query-service
        # In a real deployment, you'd push this to a container registry
        # For now, assume the image is built and available
        image: dp-query-service:latest
        imagePullPolicy: IfNotPresent  # Try local first, then pull
        ports:
        - containerPort: 50052
          name: grpc
          protocol: TCP
        env:
        - name: DP_MONGO_HOST
          value: "mongodb"  # References the MongoDB service name
        command:
        - "java"
        args:
        - "-Xmx400m"  # Set max heap to 400MB, leave more room for off-heap
        - "-Xms200m"  # Initial heap size
        - "-Ddp.MongoClient.dbHost=mongodb"
        - "-cp"
        - "/app/dp-service.jar"
        - "com.ospreydcs.dp.service.query.server.QueryGrpcServer"
        resources:
          requests:
            memory: "200Mi"
            cpu: "100m"
          limits:
            memory: "800Mi"  # Further increased to prevent OOMKills
            cpu: "300m"
        # Health checks for gRPC services
        livenessProbe:
          tcpSocket:
            port: 50052
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 50052
          initialDelaySeconds: 5
          periodSeconds: 5