#/bin/bash

echo
echo '================================================================'
echo 'app-run-docker-test-data-generator'
echo '================================================================'
echo

APP_NAME="mldp-app-test-data-generator:latest"
APP_DOCKERFILE="../docker/applications/JavaApp/Dockerfile"
APP_BUILD_CONTEXT=".."

# use the envoy ingestion load balancer started by the dp-ecosystem docker compose configuration
DOCKER_NETWORK="dp-ecosystem_eco-network"
CLIENT_CONNECT_STRING="eco-envoy:8080"

# use the ingest server started by server-docker-ingest-start, which uses docker to connect to the multi-node docker mongo replica set config mongo-replica-set-multi
# DOCKER_NETWORK="mongo-replica-set-multi_mongo-cluster"
# CLIENT_CONNECT_STRING="dp-ingestion-server:50051"

echo "üîß Building app: $APP_NAME"
docker build -f "$APP_DOCKERFILE" -t "$APP_NAME" "$APP_BUILD_CONTEXT"
if [ $? -ne 0 ]; then
  echo "‚ùå Docker build failed."
  exit 1
fi

echo "üöÄ Running app: $APP_NAME"
docker run --rm --network "$DOCKER_NETWORK"  "$APP_NAME" \
  -Ddp.GrpcClient.ingestionConnectString="$CLIENT_CONNECT_STRING" \
  -cp /app/dp-service.jar \
  com.ospreydcs.dp.service.ingest.utility.TestDataGenerator
if [ $? -ne 0 ]; then
  echo "‚ùå Docker run failed."
  exit 1
fi
